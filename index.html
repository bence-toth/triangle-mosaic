<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Triangles background generator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body, #svgRoot {
      height: 100%;
    }
    #root {
      height: 100%;
      display: flex;
    }
    #sidebar {
      flex-shrink: 0;
      width: 320px;
      height: 100%;
    }
    #svgRoot {
      width: calc(100% - 320px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0;
      background-color: hsl(0, 0%, 97.5%);
    }
    #output {
      box-shadow: 0 0 30px hsl(0, 0%, 75%);
      background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH5AgJFBoEoBbCEQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAArSURBVDjLY0xLS/vPgAcYGxvjk2ZgYqAQjBowGAxgIRTPZ8+eHQ3E4W8AAEktBewUY/QYAAAAAElFTkSuQmCC');
    }
  </style>
</head><body>
  <div id="root">
    <aside id="sidebar">
      <fieldset>
        <legend>Dimensions</legend>
        <div class="formField">
          <label for="form-width">Width</label>
          <input id="form-width" type="number" min="120" value="960" />
        </div>
        <div class="formField">
          <label for="form-height">Height</label>
          <input id="form-height" type="number" min="120" value="720" />
        </div>
        <div class="formField">
          <label for="form-x-resolution">Number of tiles horizontally</label>
          <input id="form-x-resolution" type="number" min="4" max="128" value="16" />
        </div>
        <div class="formField">
          <label for="form-y-resolution">Number of tiles vertically</label>
          <input id="form-y-resolution" type="number" min="4" max="128" value="16" />
        </div>
      </fieldset>
      <fieldset>
        <legend>Variance</legend>
        <div class="formField">
          <label for="form-shape-fuzz">Shape variance</label>
          <input id="form-shape-fuzz" type="range" min="0" max="3" value="0.65" step="0.01" />
        </div>
        <div class="formField">
          <label for="form-hue-fuzz">Hue variance</label>
          <input id="form-hue-fuzz" type="range" min="0" max="1" value="0.1" step="0.01" />
        </div>
        <div class="formField">
          <label for="form-saturation-fuzz">Saturation variance</label>
          <input id="form-saturation-fuzz" type="range" min="0" max="1" value="0.1" step="0.01" />
        </div>
        <div class="formField">
          <label for="form-lightness-fuzz">Lightness variance</label>
          <input id="form-lightness-fuzz" type="range" min="0" max="1" value="0.1" step="0.01" />
        </div>
        <div class="formField">
          <label for="form-alpha-fuzz">Alpha variance</label>
          <input id="form-alpha-fuzz" type="range" min="0" max="1" value="0" step="0.01" />
        </div>
      </fieldset>
      <fieldset>
        <legend>Coloring</legend>
        <div class="formField">
          <label for="form-coloring-mode-select">Coloring mode</label>
          <select id="form-coloring-mode-select">
            <option value="single" selected>Single color</option>
            <option value="linearGradient">Linear gradient</option>
            <option value="radialGradient">Radial gradient</option>
            <option value="spots">Light spots</option>
          </select>
        </div>
        <div class="coloringOptions" data-mode="single">
          <div class="formField">
            <label for="form-coloring-single-color">Color</label>
            <input id="form-coloring-single-color" type="color" value="#ffc107" />
          </div>
        </div>
        <div class="coloringOptions" data-mode="gradient" style="display: none;">
          <div class="formField">
            <label for="form-coloring-gradient-start-x">Start X</label>
            <input id="form-coloring-gradient-start-x" type="number" value="0" />
          </div>
          <div class="formField">
            <label for="form-coloring-gradient-start-y">Start Y</label>
            <input id="form-coloring-gradient-start-y" type="number" value="0" />
          </div>
          <div class="formField">
            <label for="form-coloring-gradient-end-x">End X</label>
            <input id="form-coloring-gradient-end-x" type="number" value="0" />
          </div>
          <div class="formField">
            <label for="form-coloring-gradient-end-y">End Y</label>
            <input id="form-coloring-gradient-end-y" type="number" value="0" />
          </div>
          <div>
            Stops:
            <div id="gradient-stops">
            </div>
          </div>
        </div>
        <div class="coloringOptions" data-mode="spots" style="display: none;">
          Spots:
        </div>
      </fieldset>
    </aside>
    <div id="svgRoot">
      <div id="output"></div>
    </div>
  </div>
  <script type="module">
    import TriangleMosaic from './triangle-mosaic/triangle-mosaic.js';

    const getRandomBetween = (min, max) => min + (Math.random() * (max - min))

    const output = document.getElementById('output')

    const state = {
      width: document.getElementById('svgRoot').clientWidth,
      height: document.getElementById('svgRoot').clientHeight,
      xResolution: 16,
      yResolution: 16,
      shapeFuzz: 0.65,
      colorFuzz: {
        hue: 0.1,
        saturation: 0.1,
        lightness: 0.1,
        alpha: 0
      },
      coloringMode: 'single',
      coloringSingle: {
        color: '#ffc107'
      },
      coloringGradient: {
        start: {
          x: 0,
          y: 0
        },
        end: {
          x: document.getElementById('svgRoot').clientWidth,
          y: document.getElementById('svgRoot').clientHeight
        },
        stops: [
          [0, '#9c27b0'],
          [0.25, '#03a9f4'],
          [0.5, '#8bc34a'],
          [0.75, '#ffc107'],
          [1, '#f44336']
        ]
      },
      coloringSpots: {
        spots: [
          {
            x: 0,
            y: 0,
            color: '#ffc107',
            intensity: 0.65
          },
          {
            x: 1280,
            y: 0,
            color: '#f44336',
            intensity: 0.6
          },
          {
            x: 640,
            y: 720,
            color: '#2196f3'
          }
        ]
      }
    }

    const getFullConfigFromState = ({
      width,
      height,
      xResolution,
      yResolution,
      shapeFuzz,
      colorFuzz,
      coloringMode,
      coloringSingle,
      coloringGradient,
      coloringSpots
    }) => ({
      width,
      height,
      xResolution,
      yResolution,
      shapeFuzz,
      colorFuzz,
      coloring: {
        mode: coloringMode,
        ...((coloringMode === 'single') && coloringSingle),
        ...((coloringMode === 'linearGradient') && coloringGradient),
        ...((coloringMode === 'radialGradient') && coloringGradient),
        ...((coloringMode === 'spots') && coloringSpots)
      }
    })

    const triangleMosaic = new TriangleMosaic(getFullConfigFromState(state))
    output.innerHTML = triangleMosaic.render()

    // TODO: Do all this based on state
    document.getElementById('form-width').value = state.width
    document.getElementById('form-height').value = state.height

    const renderStop = ({id, location, color, isBoundary}) => `
      <div class="stop">
        <div class="formField">
          <label for="form-coloring-gradient-stop-${id}-location">End X</label>
          <input
            id="form-coloring-gradient-stop-${id}-location"
            type="number"
            value="${location}"
            min="0"
            max="1"
            step="0.01"
            ${isBoundary ? 'disabled' : ''}
          />
        </div>
        <div class="formField">
          <label for="form-coloring-gradient-stop-${id}-color">End Y</label>
          <input id="form-coloring-gradient-stop-${id}-color" type="color" value="${color}" />
        </div>
      </div>
    `

    const getColoringConfigFromState = ({
      coloringMode,
      coloringSingle,
      coloringGradient,
      coloringSpots
    }) => ({
      coloring: {
        mode: coloringMode,
        ...((coloringMode === 'single') && coloringSingle),
        ...((coloringMode === 'linearGradient') && coloringGradient),
        ...((coloringMode === 'radialGradient') && coloringGradient),
        ...((coloringMode === 'spots') && coloringSpots)
      }
    })

    const handleSimpleFormInteraction = ({id, propertyName, parentPropertyName}) => {
      const formElement = document.getElementById(id)
      const listenerType = formElement.type === 'range' ? 'input' : 'change'

      formElement.addEventListener(listenerType, ({
        target: {value}
      }) => {
        if (parentPropertyName) {
          state[parentPropertyName][propertyName] = Number(value)
        }
        else {
          state[propertyName] = Number(value)
        }
        const data = {
          ...(
            parentPropertyName
              ? {
                [parentPropertyName]: {
                  ...state[parentPropertyName],
                  [propertyName]: state[parentPropertyName][propertyName]
                }
              }
              : {
                [propertyName]: state[propertyName]
              }
          )
        }
        output.innerHTML = triangleMosaic.rehydrate(data)
      })
    }

    const setupFormDimensions = () => {
      handleSimpleFormInteraction({
        id: 'form-width',
        propertyName: 'width'
      })
      handleSimpleFormInteraction({
        id: 'form-height',
        propertyName: 'height'
      })
      handleSimpleFormInteraction({
        id: 'form-x-resolution',
        propertyName: 'xResolution'
      })
      handleSimpleFormInteraction({
        id: 'form-y-resolution',
        propertyName: 'yResolution'
      })
    }

    const setupFormVariance = () => {
      handleSimpleFormInteraction({
        id: 'form-shape-fuzz',
        propertyName: 'shapeFuzz'
      })
      handleSimpleFormInteraction({
        id: 'form-hue-fuzz',
        parentPropertyName: 'colorFuzz',
        propertyName: 'hue'
      })
      handleSimpleFormInteraction({
        id: 'form-saturation-fuzz',
        parentPropertyName: 'colorFuzz',
        propertyName: 'saturation'
      })
      handleSimpleFormInteraction({
        id: 'form-lightness-fuzz',
        parentPropertyName: 'colorFuzz',
        propertyName: 'lightness'
      })
      handleSimpleFormInteraction({
        id: 'form-alpha-fuzz',
        parentPropertyName: 'colorFuzz',
        propertyName: 'alpha'
      })
    }

    const setupFormColoring = () => {
      // Coloring
      document
        .getElementById('form-coloring-mode-select')
        .addEventListener('change', ({
          target: {value: mode}
        }) => {
          state.coloringMode = mode
          const data = getColoringConfigFromState(state)
          output.innerHTML = triangleMosaic.rehydrate(data)
          document
            .querySelector('.coloringOptions[data-mode="single"]')
            .style.display = (mode === 'single') ? 'block' : 'none';
          document
            .querySelector('.coloringOptions[data-mode="gradient"]')
            .style.display = (['linearGradient', 'radialGradient'].includes(mode)) ? 'block' : 'none';
        })

      // Coloring: Single color
      document
        .getElementById('form-coloring-single-color')
        .addEventListener('input', ({
          target: {value: color}
        }) => {
          state.coloringSingle.color = color
          const data = getColoringConfigFromState(state)
          output.innerHTML = triangleMosaic.rehydrate(data)
        })

      // Coloring: Gradient
      document
        .getElementById('form-coloring-gradient-start-x')
        .addEventListener('change', ({
          target: {value: x}
        }) => {
          state.coloringGradient.start.x = Number(x)
          const data = getColoringConfigFromState(state)
          output.innerHTML = triangleMosaic.rehydrate(data)
        })
      document
        .getElementById('form-coloring-gradient-start-y')
        .addEventListener('change', ({
          target: {value: y}
        }) => {
          state.coloringGradient.start.y = Number(y)
          const data = getColoringConfigFromState(state)
          output.innerHTML = triangleMosaic.rehydrate(data)
        })
      document
        .getElementById('form-coloring-gradient-end-x')
        .addEventListener('change', ({
          target: {value: x}
        }) => {
          state.coloringGradient.end.x = Number(x)
          const data = getColoringConfigFromState(state)
          output.innerHTML = triangleMosaic.rehydrate(data)
        })
      document
        .getElementById('form-coloring-gradient-end-y')
        .addEventListener('change', ({
          target: {value: y}
        }) => {
          state.coloringGradient.end.y = Number(y)
          const data = getColoringConfigFromState(state)
          output.innerHTML = triangleMosaic.rehydrate(data)
        })
      document.getElementById('gradient-stops').innerHTML = (
        state.coloringGradient.stops
          .map(([location, color], index) => renderStop({
            id: index,
            location,
            color,
            isBoundary: [0, state.coloringGradient.stops.length - 1].includes(index)
          }))
          .join('')
      )
      state.coloringGradient.stops.forEach((stop, stopIndex) => {
        document
          .getElementById(`form-coloring-gradient-stop-${stopIndex}-location`)
          .addEventListener('change', ({
            target: {value: location}
          }) => {
            state.coloringGradient.stops[stopIndex][0] = Number(location)
            const data = getColoringConfigFromState(state)
            output.innerHTML = triangleMosaic.rehydrate(data)
            // Should also re-render form segment if ordering is wrong now
          })
        document
          .getElementById(`form-coloring-gradient-stop-${stopIndex}-color`)
          .addEventListener('input', ({
            target: {value: color}
          }) => {
            state.coloringGradient.stops[stopIndex][1] = color
            const data = getColoringConfigFromState(state)
            output.innerHTML = triangleMosaic.rehydrate(data)
          })
      })
      // TODO: Add stop
      // TODO: Remove stop
      // TODO: Update spot
      // TODO: Add spot
      // TODO: Remove spot
      // TODO: Display gradient on canvas
      // TODO: Display spots on canvas
      // TODO: Add linear gradient presets
      // TODO: Add radial gradient presets
      // TODO: Add randomize options button
      // TODO: Add randomize grid button (no options change)
      // TODO: Add spot presets
      // TODO: Add styles
      // TODO: Add "branding", link to docs etc.
      // TODO: Move logic to modules, create some separation of concerns
    }

    const setupForm = () => {
      setupFormDimensions()
      setupFormVariance()
      setupFormColoring()
    }

    setupForm()
  </script>
</body></html>
